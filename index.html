<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ìš°ì¬ ì°©ìƒ· ì¶”ì²œ - ë‚ ì”¨ë³„ íŒ¨ì…˜</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .admin-link {
            text-align: center;
            margin-top: 15px;
        }

        .admin-link a {
            color: white;
            text-decoration: none;
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .admin-link a:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .location-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .location-input {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        input[type="text"] {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            width: 250px;
            transition: border 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .weather-info {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .weather-info h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .weather-details {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .weather-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .weather-item .label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .weather-item .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }

        .temperature {
            font-size: 3em !important;
            color: #667eea;
        }

        .outfit-section h2 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        .outfit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .outfit-card {
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .outfit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .outfit-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .outfit-info {
            padding: 15px;
            text-align: center;
        }

        .outfit-info h3 {
            color: #333;
            margin-bottom: 5px;
        }

        .outfit-info p {
            color: #666;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 20px;
            background: #ffe0e0;
            color: #d00;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        /* ìƒì„¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .detail-modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .detail-modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .detail-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 35px;
            height: 35px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .detail-modal-close:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        .detail-modal-image {
            width: 100%;
            height: 400px;
            object-fit: cover;
            border-radius: 20px 20px 0 0;
        }

        .detail-modal-body {
            padding: 30px;
        }

        .detail-modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .detail-modal-header h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .detail-modal-header p {
            color: #666;
            margin-bottom: 5px;
        }

        /* ë³„ì  ì‹œìŠ¤í…œ */
        .rating-section {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .rating-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .star-rating {
            display: flex;
            justify-content: center;
            gap: 10px;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .star {
            cursor: pointer;
            color: #ddd;
            transition: color 0.2s, transform 0.2s;
        }

        .star:hover,
        .star.active {
            color: #ffd700;
            transform: scale(1.1);
        }

        .rating-display {
            color: #666;
            font-size: 0.9em;
        }

        /* ì°©ìš© ê¸°ë¡ ì„¹ì…˜ */
        .wear-history-section {
            margin-top: 20px;
        }

        .wear-history-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .add-wear-date {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .add-wear-date input[type="date"] {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 0.95em;
        }

        .add-wear-date button {
            padding: 10px 20px;
            white-space: nowrap;
        }

        .wear-history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .wear-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .wear-history-item .date {
            color: #333;
            font-weight: 500;
        }

        .wear-history-item .delete-btn {
            padding: 5px 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            margin: 0;
        }

        .wear-history-item .delete-btn:hover {
            background: #c82333;
            transform: none;
            box-shadow: none;
        }

        .empty-history {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 0.9em;
        }

        /* í‰ì  ë°°ì§€ */
        .rating-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            background: rgba(255, 215, 0, 0.2);
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .rating-badge .star-icon {
            color: #ffd700;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.8em;
            }

            .card {
                padding: 20px;
            }

            .weather-details {
                gap: 15px;
            }

            .detail-modal-content {
                max-height: 95vh;
            }

            .detail-modal-image {
                height: 250px;
            }

            .detail-modal-body {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‘” ì£¼ìš°ì¬ ì°©ìƒ· ì¶”ì²œ</h1>
            <p>ì˜¤ëŠ˜ ë‚ ì”¨ì— ë§ëŠ” ì£¼ìš°ì¬ ìŠ¤íƒ€ì¼ì„ ì°¾ì•„ë³´ì„¸ìš”</p>
            <div class="admin-link">
                <a href="admin.html">âš™ï¸ ê´€ë¦¬ì í˜ì´ì§€</a>
            </div>
        </div>

        <div class="card">
            <div class="location-section">
                <div class="location-input">
                    <input type="text" id="cityInput" placeholder="ë„ì‹œ ì´ë¦„ (ì˜ˆ: Seoul)" value="Seoul">
                    <button onclick="getWeather()">ë‚ ì”¨ í™•ì¸</button>
                    <button onclick="getCurrentLocation()">ë‚´ ìœ„ì¹˜</button>
                </div>
            </div>

            <div id="error" class="error hidden"></div>
            <div id="loading" class="loading hidden">ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>

            <div id="weatherInfo" class="weather-info hidden">
                <h2 id="cityName">-</h2>
                <div class="weather-details">
                    <div class="weather-item">
                        <div class="label">ì˜¨ë„</div>
                        <div class="value temperature" id="temperature">-</div>
                    </div>
                    <div class="weather-item">
                        <div class="label">ë‚ ì”¨</div>
                        <div class="value" id="weatherDesc">-</div>
                    </div>
                    <div class="weather-item">
                        <div class="label">ì²´ê°ì˜¨ë„</div>
                        <div class="value" id="feelsLike">-</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="outfitSection" class="card hidden">
            <div class="outfit-section">
                <h2>ğŸ¨ ì¶”ì²œ ì°©ìƒ·</h2>
                <div id="outfitGrid" class="outfit-grid"></div>
            </div>
        </div>
    </div>

    <!-- ìƒì„¸ ëª¨ë‹¬ -->
    <div id="detailModal" class="detail-modal" onclick="closeDetailModal(event)">
        <div class="detail-modal-content">
            <button class="detail-modal-close" onclick="closeDetailModal(event)">&times;</button>

            <img id="detailImage" class="detail-modal-image" src="" alt="">

            <div class="detail-modal-body">
                <div class="detail-modal-header">
                    <h2 id="detailTitle"></h2>
                    <p id="detailDescription"></p>
                    <p><strong id="detailTemp"></strong></p>
                </div>

                <!-- ë³„ì  ì„¹ì…˜ -->
                <div class="rating-section">
                    <h3>â­ ì´ ì°©ìƒ· í‰ê°€í•˜ê¸°</h3>
                    <div class="star-rating" id="starRating">
                        <span class="star" data-rating="1">â˜…</span>
                        <span class="star" data-rating="2">â˜…</span>
                        <span class="star" data-rating="3">â˜…</span>
                        <span class="star" data-rating="4">â˜…</span>
                        <span class="star" data-rating="5">â˜…</span>
                    </div>
                    <div class="rating-display" id="ratingDisplay">ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                </div>

                <!-- ì°©ìš© ê¸°ë¡ ì„¹ì…˜ -->
                <div class="wear-history-section">
                    <h3>ğŸ“… ì°©ìš© ê¸°ë¡</h3>
                    <div class="add-wear-date">
                        <input type="date" id="wearDate">
                        <button onclick="addWearDate()">ê¸°ë¡ ì¶”ê°€</button>
                    </div>
                    <div class="wear-history-list" id="wearHistoryList">
                        <div class="empty-history">ì•„ì§ ì°©ìš© ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Open-Meteo API (ë¬´ë£Œ, API í‚¤ ë¶ˆí•„ìš”)

        // í˜„ì¬ ì„ íƒëœ ì°©ìƒ·
        let currentOutfit = null;

        // ì£¼ìš°ì¬ ì°©ìƒ· ë°ì´í„°ë² ì´ìŠ¤ (ìƒ˜í”Œ)
        const outfitDatabase = {
            hot: [ // 25ë„ ì´ìƒ
                {
                    title: 'ì—¬ë¦„ í™”ì´íŠ¸ ì…”ì¸  ë£©',
                    description: 'ì‹œì›í•œ í™”ì´íŠ¸ ì…”ì¸  + ë² ì´ì§€ íŒ¬ì¸ ',
                    image: 'https://via.placeholder.com/300x400/FFE4B5/000000?text=%EC%97%AC%EB%A6%84+%ED%99%94%EC%9D%B4%ED%8A%B8+%EB%A3%A9',
                    temp: '25-30Â°C'
                },
                {
                    title: 'ìºì£¼ì–¼ í‹°ì…”ì¸  ë£©',
                    description: 'ë¸”ë™ í‹°ì…”ì¸  + ë°ë‹˜ íŒ¬ì¸ ',
                    image: 'https://via.placeholder.com/300x400/87CEEB/000000?text=%EC%BA%90%EC%A5%AC%EC%96%BC+%ED%8B%B0%EC%85%94%EC%B8%A0',
                    temp: '25-30Â°C'
                },
                {
                    title: 'ì„œë¨¸ ë¦°ë„¨ ë£©',
                    description: 'ë¦°ë„¨ ì…”ì¸  + ìˆíŒ¬ì¸ ',
                    image: 'https://via.placeholder.com/300x400/FFF8DC/000000?text=%EC%84%9C%EB%A8%B8+%EB%A6%B0%EB%84%A8',
                    temp: '28-35Â°C'
                }
            ],
            warm: [ // 15-25ë„
                {
                    title: 'ë´„ ê°€ë””ê±´ ë£©',
                    description: 'ê°€ë””ê±´ + í™”ì´íŠ¸í‹° + ìŠ¬ë™ìŠ¤',
                    image: 'https://via.placeholder.com/300x400/FFB6C1/000000?text=%EB%B4%84+%EA%B0%80%EB%94%94%EA%B1%B4',
                    temp: '15-22Â°C'
                },
                {
                    title: 'ì…”ì¸  ë ˆì´ì–´ë“œ ë£©',
                    description: 'ì²´í¬ ì…”ì¸  + ì²­ë°”ì§€',
                    image: 'https://via.placeholder.com/300x400/DDA0DD/000000?text=%EC%85%94%EC%B8%A0+%EB%A0%88%EC%9D%B4%EC%96%B4%EB%93%9C',
                    temp: '18-24Â°C'
                },
                {
                    title: 'ë‹ˆíŠ¸ ìºì£¼ì–¼ ë£©',
                    description: 'ì–‡ì€ ë‹ˆíŠ¸ + ì¹˜ë…¸íŒ¬ì¸ ',
                    image: 'https://via.placeholder.com/300x400/F0E68C/000000?text=%EB%8B%88%ED%8A%B8+%EC%BA%90%EC%A5%AC%EC%96%BC',
                    temp: '15-20Â°C'
                }
            ],
            cool: [ // 5-15ë„
                {
                    title: 'íŠ¸ë Œì¹˜ ì½”íŠ¸ ë£©',
                    description: 'íŠ¸ë Œì¹˜ ì½”íŠ¸ + ë‹ˆíŠ¸ + ìŠ¬ë™ìŠ¤',
                    image: 'https://via.placeholder.com/300x400/D2B48C/000000?text=%ED%8A%B8%EB%A0%8C%EC%B9%98+%EC%BD%94%ED%8A%B8',
                    temp: '10-15Â°C'
                },
                {
                    title: 'ìì¼“ ë ˆì´ì–´ë“œ ë£©',
                    description: 'ì¬í‚· + í›„ë“œí‹° + ì²­ë°”ì§€',
                    image: 'https://via.placeholder.com/300x400/BC8F8F/000000?text=%EC%9E%90%EC%BC%93+%EB%A0%88%EC%9D%B4%EC%96%B4%EB%93%9C',
                    temp: '8-14Â°C'
                },
                {
                    title: 'ê°€ì„ ìš¸ ì½”íŠ¸ ë£©',
                    description: 'ìš¸ ì½”íŠ¸ + í„°í‹€ë„¥',
                    image: 'https://via.placeholder.com/300x400/A0522D/000000?text=%EA%B0%80%EC%9D%84+%EC%9A%B8+%EC%BD%94%ED%8A%B8',
                    temp: '5-12Â°C'
                }
            ],
            cold: [ // 5ë„ ì´í•˜
                {
                    title: 'ê²¨ìš¸ ë¡±íŒ¨ë”© ë£©',
                    description: 'ë¡±íŒ¨ë”© + ëª©ë„ë¦¬ + ê¸°ëª¨ íŒ¬ì¸ ',
                    image: 'https://via.placeholder.com/300x400/4682B4/FFFFFF?text=%EA%B2%A8%EC%9A%B8+%EB%A1%B1%ED%8C%A8%EB%94%A9',
                    temp: '-5-5Â°C'
                },
                {
                    title: 'ìˆíŒ¨ë”© ìºì£¼ì–¼ ë£©',
                    description: 'ìˆíŒ¨ë”© + í›„ë“œ + ì²­ë°”ì§€',
                    image: 'https://via.placeholder.com/300x400/2F4F4F/FFFFFF?text=%EC%88%8F%ED%8C%A8%EB%94%A9+%EC%BA%90%EC%A5%AC%EC%96%BC',
                    temp: '0-8Â°C'
                },
                {
                    title: 'ê²¨ìš¸ ì½”íŠ¸ í¬ë©€ ë£©',
                    description: 'ìš¸ ì½”íŠ¸ + ë‹ˆíŠ¸ + ìŠ¬ë™ìŠ¤',
                    image: 'https://via.placeholder.com/300x400/191970/FFFFFF?text=%EA%B2%A8%EC%9A%B8+%EC%BD%94%ED%8A%B8',
                    temp: '-10-5Â°C'
                }
            ],
            rainy: [ // ë¹„ì˜¤ëŠ” ë‚ 
                {
                    title: 'ë ˆì¸ ì¬í‚· ë£©',
                    description: 'ë ˆì¸ ì¬í‚· + ë°©ìˆ˜ íŒ¬ì¸ ',
                    image: 'https://via.placeholder.com/300x400/708090/FFFFFF?text=%EB%A0%88%EC%9D%B8+%EC%9E%AC%ED%82%B7',
                    temp: 'ë¹„ì˜¤ëŠ” ë‚ '
                },
                {
                    title: 'íŠ¸ë Œì¹˜ ì½”íŠ¸ ìš°ì²œ ë£©',
                    description: 'ë°©ìˆ˜ íŠ¸ë Œì¹˜ + ìš°ì‚°',
                    image: 'https://via.placeholder.com/300x400/778899/FFFFFF?text=%ED%8A%B8%EB%A0%8C%EC%B9%98+%EC%9A%B0%EC%B2%9C',
                    temp: 'ë¹„ì˜¤ëŠ” ë‚ '
                }
            ]
        };

        // IndexedDB ì´ˆê¸°í™” ë° ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        let db;

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('OutfitDB', 1);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('outfits')) {
                        const objectStore = db.createObjectStore('outfits', { keyPath: 'id' });
                        objectStore.createIndex('category', 'category', { unique: false });
                    }
                };
            });
        }

        async function getAllOutfitsFromDB() {
            if (!db) await initDB();

            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['outfits'], 'readonly');
                const objectStore = transaction.objectStore('outfits');
                const request = objectStore.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // IndexedDBì—ì„œ ì°©ìƒ· ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function getOutfitsFromStorage() {
            try {
                const allOutfits = await getAllOutfitsFromDB();

                if (allOutfits && allOutfits.length > 0) {
                    // IndexedDB ë°ì´í„°ë¥¼ ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í™”
                    const grouped = {};
                    allOutfits.forEach(outfit => {
                        if (!grouped[outfit.category]) {
                            grouped[outfit.category] = [];
                        }
                        grouped[outfit.category].push(outfit);
                    });
                    return grouped;
                }
            } catch (e) {
                console.error('IndexedDB ì½ê¸° ì˜¤ë¥˜:', e);
            }

            // ì—†ìœ¼ë©´ ê¸°ë³¸ ìƒ˜í”Œ ë°ì´í„° ë°˜í™˜
            return outfitDatabase;
        }

        // ë‚ ì”¨ì— ë”°ë¥¸ ì°©ìƒ· ë§¤ì¹­ í•¨ìˆ˜
        async function getOutfitsByWeather(temp, weatherMain) {
            const database = await getOutfitsFromStorage();

            // ë¹„ê°€ ì˜¤ëŠ” ê²½ìš°
            if (weatherMain.toLowerCase().includes('rain')) {
                return database.rainy || [];
            }

            // ì˜¨ë„ë³„ ë§¤ì¹­
            if (temp >= 25) {
                return database.hot || [];
            } else if (temp >= 15) {
                return database.warm || [];
            } else if (temp >= 5) {
                return database.cool || [];
            } else {
                return database.cold || [];
            }
        }

        // ë„ì‹œ ì´ë¦„ì„ ì¢Œí‘œë¡œ ë³€í™˜
        async function getCityCoordinates(city) {
            const cityCoords = {
                'Seoul': { lat: 37.5665, lon: 126.9780, name: 'ì„œìš¸' },
                'Busan': { lat: 35.1796, lon: 129.0756, name: 'ë¶€ì‚°' },
                'Incheon': { lat: 37.4563, lon: 126.7052, name: 'ì¸ì²œ' },
                'Daegu': { lat: 35.8714, lon: 128.6014, name: 'ëŒ€êµ¬' },
                'Daejeon': { lat: 36.3504, lon: 127.3845, name: 'ëŒ€ì „' },
                'Gwangju': { lat: 35.1595, lon: 126.8526, name: 'ê´‘ì£¼' },
                'Ulsan': { lat: 35.5384, lon: 129.3114, name: 'ìš¸ì‚°' }
            };

            const cityLower = city.toLowerCase();
            for (const [key, value] of Object.entries(cityCoords)) {
                if (key.toLowerCase() === cityLower) {
                    return value;
                }
            }

            // ê¸°ë³¸ê°’: ì„œìš¸
            return cityCoords['Seoul'];
        }

        // ë‚ ì”¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        async function getWeather() {
            const city = document.getElementById('cityInput').value.trim();

            if (!city) {
                showError('ë„ì‹œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            showLoading(true);
            hideError();

            try {
                const coords = await getCityCoordinates(city);

                // Open-Meteo API í˜¸ì¶œ
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current=temperature_2m,apparent_temperature,weather_code&timezone=Asia/Seoul`;
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error('ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                const data = await response.json();

                // OpenWeatherMap í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                const weatherData = {
                    name: coords.name,
                    main: {
                        temp: data.current.temperature_2m,
                        feels_like: data.current.apparent_temperature
                    },
                    weather: [{
                        main: getWeatherType(data.current.weather_code),
                        description: getWeatherDescription(data.current.weather_code)
                    }]
                };

                displayWeather(weatherData);
            } catch (error) {
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        // WMO ë‚ ì”¨ ì½”ë“œë¥¼ ë‚ ì”¨ íƒ€ì…ìœ¼ë¡œ ë³€í™˜
        function getWeatherType(code) {
            if (code === 0) return 'Clear';
            if (code <= 3) return 'Clouds';
            if (code >= 51 && code <= 67) return 'Rain';
            if (code >= 71 && code <= 77) return 'Snow';
            if (code >= 80 && code <= 82) return 'Rain';
            if (code >= 85 && code <= 86) return 'Snow';
            if (code >= 95) return 'Thunderstorm';
            return 'Clouds';
        }

        // WMO ë‚ ì”¨ ì½”ë“œë¥¼ í•œê¸€ ì„¤ëª…ìœ¼ë¡œ ë³€í™˜
        function getWeatherDescription(code) {
            const descriptions = {
                0: 'ë§‘ìŒ',
                1: 'ëŒ€ì²´ë¡œ ë§‘ìŒ',
                2: 'ë¶€ë¶„ì ìœ¼ë¡œ íë¦¼',
                3: 'íë¦¼',
                45: 'ì•ˆê°œ',
                48: 'ì•ˆê°œ',
                51: 'ê°€ë²¼ìš´ ì´ìŠ¬ë¹„',
                53: 'ì´ìŠ¬ë¹„',
                55: 'ê°•í•œ ì´ìŠ¬ë¹„',
                61: 'ì•½í•œ ë¹„',
                63: 'ë¹„',
                65: 'ê°•í•œ ë¹„',
                71: 'ì•½í•œ ëˆˆ',
                73: 'ëˆˆ',
                75: 'ê°•í•œ ëˆˆ',
                80: 'ì†Œë‚˜ê¸°',
                81: 'ê°•í•œ ì†Œë‚˜ê¸°',
                82: 'ë§¤ìš° ê°•í•œ ì†Œë‚˜ê¸°',
                95: 'ë‡Œìš°',
                96: 'ìš°ë°•ì„ ë™ë°˜í•œ ë‡Œìš°',
                99: 'ê°•í•œ ìš°ë°•ì„ ë™ë°˜í•œ ë‡Œìš°'
            };
            return descriptions[code] || 'ì•Œ ìˆ˜ ì—†ìŒ';
        }

        // í˜„ì¬ ìœ„ì¹˜ ë‚ ì”¨ ê°€ì ¸ì˜¤ê¸°
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                showError('ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
                return;
            }

            showLoading(true);
            hideError();

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    try {
                        const { latitude, longitude } = position.coords;

                        // Open-Meteo API í˜¸ì¶œ
                        const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,apparent_temperature,weather_code&timezone=Asia/Seoul`;
                        const response = await fetch(url);

                        if (!response.ok) {
                            throw new Error('ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }

                        const data = await response.json();

                        // OpenWeatherMap í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                        const weatherData = {
                            name: 'í˜„ì¬ ìœ„ì¹˜',
                            main: {
                                temp: data.current.temperature_2m,
                                feels_like: data.current.apparent_temperature
                            },
                            weather: [{
                                main: getWeatherType(data.current.weather_code),
                                description: getWeatherDescription(data.current.weather_code)
                            }]
                        };

                        displayWeather(weatherData);
                    } catch (error) {
                        showError(error.message);
                    } finally {
                        showLoading(false);
                    }
                },
                (error) => {
                    showError('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìœ„ì¹˜ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    showLoading(false);
                }
            );
        }

        // ë‚ ì”¨ ì •ë³´ í‘œì‹œ
        function displayWeather(data) {
            document.getElementById('cityName').textContent = data.name;
            document.getElementById('temperature').textContent = `${Math.round(data.main.temp)}Â°C`;
            document.getElementById('weatherDesc').textContent = data.weather[0].description;
            document.getElementById('feelsLike').textContent = `${Math.round(data.main.feels_like)}Â°C`;

            document.getElementById('weatherInfo').classList.remove('hidden');

            // ì°©ìƒ· ì¶”ì²œ
            displayOutfits(data.main.temp, data.weather[0].main);
        }

        // ì°©ìƒ· í‘œì‹œ
        async function displayOutfits(temp, weatherMain) {
            const outfits = await getOutfitsByWeather(temp, weatherMain);
            const grid = document.getElementById('outfitGrid');

            grid.innerHTML = '';

            if (outfits.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">
                        <p>ì´ ë‚ ì”¨ì— ë§ëŠ” ì°©ìƒ·ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p><a href="admin.html" style="color: #667eea;">ê´€ë¦¬ì í˜ì´ì§€</a>ì—ì„œ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>
                    </div>
                `;
            } else {
                outfits.forEach(outfit => {
                    const card = document.createElement('div');
                    card.className = 'outfit-card';

                    // í‰ì  ë°°ì§€ HTML
                    const ratingBadge = outfit.rating && outfit.rating > 0
                        ? `<div class="rating-badge"><span class="star-icon">â˜…</span> ${outfit.rating}/5</div>`
                        : '';

                    // ì°©ìš© íšŸìˆ˜ í‘œì‹œ
                    const wearCount = outfit.wearHistory && outfit.wearHistory.length > 0
                        ? `<p style="font-size: 0.85em; color: #999; margin-top: 5px;">ğŸ‘” ${outfit.wearHistory.length}íšŒ ì°©ìš©</p>`
                        : '';

                    card.innerHTML = `
                        <img src="${outfit.image}" alt="${outfit.title}" class="outfit-image">
                        <div class="outfit-info">
                            <h3>${outfit.title}</h3>
                            <p>${outfit.description}</p>
                            <p><strong>${outfit.temp}</strong></p>
                            ${ratingBadge}
                            ${wearCount}
                        </div>
                    `;

                    // ì¹´ë“œ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
                    card.addEventListener('click', () => openDetailModal(outfit));

                    grid.appendChild(card);
                });
            }

            document.getElementById('outfitSection').classList.remove('hidden');
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('error').classList.add('hidden');
        }

        // ì—”í„° í‚¤ë¡œ ê²€ìƒ‰
        document.getElementById('cityInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                getWeather();
            }
        });

        // IndexedDBì—ì„œ ì°©ìƒ· ì—…ë°ì´íŠ¸
        async function updateOutfitInDB(outfit) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['outfits'], 'readwrite');
                const objectStore = transaction.objectStore('outfits');
                const request = objectStore.put(outfit);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // IndexedDBì—ì„œ íŠ¹ì • ì°©ìƒ· ê°€ì ¸ì˜¤ê¸°
        async function getOutfitFromDB(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['outfits'], 'readonly');
                const objectStore = transaction.objectStore('outfits');
                const request = objectStore.get(id);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
        async function openDetailModal(outfit) {
            currentOutfit = outfit;

            // ë°ì´í„° ì´ˆê¸°í™” (ì—†ìœ¼ë©´ ì¶”ê°€)
            if (!currentOutfit.rating) {
                currentOutfit.rating = 0;
            }
            if (!currentOutfit.wearHistory) {
                currentOutfit.wearHistory = [];
            }

            // ëª¨ë‹¬ ë‚´ìš© ì±„ìš°ê¸°
            document.getElementById('detailImage').src = outfit.image;
            document.getElementById('detailTitle').textContent = outfit.title;
            document.getElementById('detailDescription').textContent = outfit.description;
            document.getElementById('detailTemp').textContent = outfit.temp;

            // ë³„ì  í‘œì‹œ
            updateStarDisplay(currentOutfit.rating);

            // ì°©ìš© ê¸°ë¡ í‘œì‹œ
            updateWearHistoryDisplay();

            // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('wearDate').value = today;

            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('detailModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        // ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
        function closeDetailModal(event) {
            if (event.target.id === 'detailModal' || event.target.className === 'detail-modal-close') {
                document.getElementById('detailModal').classList.remove('show');
                document.body.style.overflow = 'auto';
                currentOutfit = null;
            }
        }

        // ë³„ì  í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateStarDisplay(rating) {
            const stars = document.querySelectorAll('#starRating .star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });

            const ratingDisplay = document.getElementById('ratingDisplay');
            if (rating > 0) {
                ratingDisplay.textContent = `${rating}ì  / 5ì `;
            } else {
                ratingDisplay.textContent = 'ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
            }
        }

        // ë³„ì  í´ë¦­ ì´ë²¤íŠ¸
        document.querySelectorAll('#starRating .star').forEach(star => {
            star.addEventListener('click', async function() {
                if (!currentOutfit) return;

                const rating = parseInt(this.getAttribute('data-rating'));
                currentOutfit.rating = rating;

                // ë³„ì  í‘œì‹œ ì—…ë°ì´íŠ¸
                updateStarDisplay(rating);

                // DBì— ì €ì¥ (IDê°€ ìˆëŠ” ê²½ìš°ë§Œ)
                if (currentOutfit.id) {
                    try {
                        await updateOutfitInDB(currentOutfit);
                    } catch (error) {
                        console.error('ë³„ì  ì €ì¥ ì˜¤ë¥˜:', error);
                    }
                }
            });
        });

        // ì°©ìš© ê¸°ë¡ ì¶”ê°€
        async function addWearDate() {
            if (!currentOutfit) return;

            const dateInput = document.getElementById('wearDate');
            const date = dateInput.value;

            if (!date) {
                alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì°©ìš© ê¸°ë¡ ë°°ì—´ ì´ˆê¸°í™” (ì—†ìœ¼ë©´)
            if (!currentOutfit.wearHistory) {
                currentOutfit.wearHistory = [];
            }

            // ì¤‘ë³µ í™•ì¸
            if (currentOutfit.wearHistory.includes(date)) {
                alert('ì´ë¯¸ ì¶”ê°€ëœ ë‚ ì§œì…ë‹ˆë‹¤.');
                return;
            }

            // ì°©ìš© ê¸°ë¡ ì¶”ê°€
            currentOutfit.wearHistory.push(date);
            currentOutfit.wearHistory.sort().reverse(); // ìµœì‹ ìˆœ ì •ë ¬

            // í‘œì‹œ ì—…ë°ì´íŠ¸
            updateWearHistoryDisplay();

            // DBì— ì €ì¥ (IDê°€ ìˆëŠ” ê²½ìš°ë§Œ)
            if (currentOutfit.id) {
                try {
                    await updateOutfitInDB(currentOutfit);
                } catch (error) {
                    console.error('ì°©ìš© ê¸°ë¡ ì €ì¥ ì˜¤ë¥˜:', error);
                }
            }
        }

        // ì°©ìš© ê¸°ë¡ ì‚­ì œ
        async function deleteWearDate(date) {
            if (!currentOutfit) return;

            if (!confirm('ì´ ì°©ìš© ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            // ì°©ìš© ê¸°ë¡ì—ì„œ ì œê±°
            currentOutfit.wearHistory = currentOutfit.wearHistory.filter(d => d !== date);

            // í‘œì‹œ ì—…ë°ì´íŠ¸
            updateWearHistoryDisplay();

            // DBì— ì €ì¥ (IDê°€ ìˆëŠ” ê²½ìš°ë§Œ)
            if (currentOutfit.id) {
                try {
                    await updateOutfitInDB(currentOutfit);
                } catch (error) {
                    console.error('ì°©ìš© ê¸°ë¡ ì‚­ì œ ì˜¤ë¥˜:', error);
                }
            }
        }

        // ì°©ìš© ê¸°ë¡ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateWearHistoryDisplay() {
            const container = document.getElementById('wearHistoryList');

            if (!currentOutfit.wearHistory || currentOutfit.wearHistory.length === 0) {
                container.innerHTML = '<div class="empty-history">ì•„ì§ ì°©ìš© ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            container.innerHTML = '';
            currentOutfit.wearHistory.forEach(date => {
                const item = document.createElement('div');
                item.className = 'wear-history-item';

                // ë‚ ì§œ í¬ë§· ë³€í™˜ (YYYY-MM-DD -> YYYYë…„ MMì›” DDì¼)
                const [year, month, day] = date.split('-');
                const formattedDate = `${year}ë…„ ${month}ì›” ${day}ì¼`;

                item.innerHTML = `
                    <span class="date">${formattedDate}</span>
                    <button class="delete-btn" onclick="deleteWearDate('${date}')">ì‚­ì œ</button>
                `;
                container.appendChild(item);
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ë° ê¸°ë³¸ ë‚ ì”¨ í‘œì‹œ
        window.addEventListener('load', async () => {
            await initDB();
            getWeather();
        });

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('detailModal');
                if (modal.classList.contains('show')) {
                    modal.classList.remove('show');
                    document.body.style.overflow = 'auto';
                    currentOutfit = null;
                }
            }
        });
    </script>
</body>
</html>
